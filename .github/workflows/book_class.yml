name: AimHarder Bot

on:
  schedule:
    # Trigger at 9:40 AM UTC daily to target 10:00 AM Madrid booking window
    - cron: '40 9 * * *'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (do not actually book)'
        required: false
        default: false
        type: boolean
      days_ahead:
        description: 'Days ahead to book (default: 2)'
        required: false
        default: '2'
        type: string
      skip_wait:
        description: 'Skip waiting for target time (for testing)'
        required: false
        default: false
        type: boolean
      box_name:
        description: 'Manual override: Box name (subdomain)'
        required: false
        type: string
      box_id:
        description: 'Manual override: Box ID'
        required: false
        default: '0'
        type: string
      target_hour:
        description: 'Target hour to run (0-23)'
        required: false
        default: '10'
        type: string
      target_minute:
        description: 'Target minute to run (0-59)'
        required: false
        default: '00'
        type: string

jobs:
  book:
    runs-on: ubuntu-latest
    env:
      # Ensure shell 'date' command uses Madrid time
      TZ: Europe/Madrid

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Sleep until specific time
        if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.skip_wait != 'true')
        run: |
          target_hour=${{ github.event.inputs.target_hour || '10' }}
          target_minute=${{ github.event.inputs.target_minute || '00' }}
          target_second=1
          
          current_hour=$(date +%H)
          current_minute=$(date +%M)
          current_second=$(date +%S)

          # Remove leading zeros to avoid octal issues
          current_hour=$((10#$current_hour))
          current_minute=$((10#$current_minute))
          current_second=$((10#$current_second))
          
          target_time_in_seconds=$((target_hour * 3600 + target_minute * 60 + target_second))
          current_time_in_seconds=$((current_hour * 3600 + current_minute * 60 + current_second))

          echo "Current Madrid time: $(date +%H:%M:%S)"
          echo "Target time: $target_hour:$target_minute:01"
          
          if [ $current_time_in_seconds -ge $target_time_in_seconds ]; then
            sleep_duration=0
            echo "Target time already passed."
          else
            sleep_duration=$((target_time_in_seconds - current_time_in_seconds))
          fi

          echo "Sleeping for $sleep_duration seconds until the target time"
          sleep $sleep_duration

      - name: Run booking script
        env:
          EMAIL: ${{ secrets.EMAIL }}
          PASSWORD: ${{ secrets.PASSWORD }}
        run: |
          # Use --skip-wait because we handled the wait in the previous shell step
          OPTS="--skip-wait"
          [ "${{ github.event.inputs.dry_run }}" = "true" ] && OPTS="$OPTS --dry-run"
          
          # Use provided days_ahead or default to 2
          DAYS="${{ github.event.inputs.days_ahead || '2' }}"
          
          # 2. Manual Override Logic: If Box ID/Name is provided, run ONLY that
          if [ -n "${{ github.event.inputs.box_id }}" ] && [ "${{ github.event.inputs.box_id }}" != "0" ]; then
             echo "ðŸŽ¯ Running manual override for Box ID: ${{ github.event.inputs.box_id }}"
             python main.py $OPTS --days-ahead $DAYS --box-id ${{ github.event.inputs.box_id }} --box-name "${{ github.event.inputs.box_name }}"
             exit 0
          fi
          
          # 3. Standard Schedule: Add a line for each box you want to book
          echo "ðŸš€ Processing Box 10002..."
          python main.py $OPTS --days-ahead $DAYS --schedule schedule_10002.json
          
          echo "ðŸš€ Processing Box 9907..."
          python main.py $OPTS --days-ahead $DAYS --schedule schedule_10003.json
